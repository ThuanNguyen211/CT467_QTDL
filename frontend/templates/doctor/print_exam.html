{% extends 'base_doctor.html' %} {% block title %}In Phi·∫øu Kh√°m{% endblock %} {%
block content %}
<style>
  @media print {
    body * {
      visibility: hidden;
    }
    #printable,
    #printable * {
      visibility: visible;
    }
    #printable {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 20mm;
      font-size: 12pt;
    }
    .no-print {
      display: none;
    }
    .exam-card {
      box-shadow: none !important;
      border: none !important;
    }
  }

  .exam-card {
    border: 2px solid #000;
    padding: 20mm;
    max-width: 190mm;
    margin: auto;
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    font-family: "Times New Roman", Times, serif;
  }

  .exam-header {
    text-align: center;
    margin-bottom: 20mm;
    border-bottom: 2px solid #000;
    padding-bottom: 10px;
  }

  .exam-header h2 {
    font-size: 24pt;
    font-weight: bold;
    text-transform: uppercase;
    margin: 0;
  }

  .exam-header p {
    font-size: 14pt;
    margin: 5px 0;
  }

  .exam-section p {
    font-size: 12pt;
    margin: 4px 0;
    display: inline-block;
    width: 100%;
  }

  .exam-section strong {
    display: inline-block;
    width: 150px;
    font-weight: bold;
  }

  .exam-section table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  .exam-section th,
  .exam-section td {
    border: 1px solid #000;
    padding: 8px;
    text-align: left;
    font-size: 12pt;
  }

  .exam-section th {
    background-color: #f2f2f2;
    font-weight: bold;
  }

  .exam-footer {
    margin-top: 30mm;
    font-size: 12pt;
  }

  .exam-footer p {
    margin: 15px 0;
  }

  .signature-block {
    display: flex;
    justify-content: space-between;
  }

  .signature-line {
    border-top: 1px solid #000;
    width: 200px;
    text-align: center;
    padding-top: 5px;
  }
</style>

<div id="printable">
  <div class="exam-card">
    <div class="exam-header">
      <h2>PHI·∫æU KH√ÅM B·ªÜNH</h2>
      <p>Ph√≤ng kh√°m ƒëa khoa ABC</p>
      <p>ƒê·ªãa ch·ªâ: 123 ƒê∆∞·ªùng S·ª©c Kh·ªèe, Qu·∫≠n 1, TP. HCM</p>
      <p>Hotline: 0123 456 789</p>
    </div>

    <div class="exam-section">
      <p><strong>M√£ phi·∫øu kh√°m:</strong> <span id="ma_phieu_kham"></span></p>
      <p><strong>T√™n b·ªánh nh√¢n:</strong> <span id="ten_benh_nhan"></span></p>
      <p><strong>Ng√†y kh√°m:</strong> <span id="ngay_kham"></span></p>
      <p><strong>Tri·ªáu ch·ª©ng:</strong> <span id="trieu_chung"></span></p>
      <p><strong>Ch·∫©n ƒëo√°n:</strong> <span id="chan_doan"></span></p>
    </div>
    <div class="exam-section">
      <h4>ƒê∆°n Thu·ªëc</h4>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th style="width: 40%">T√™n thu·ªëc</th>
            <th style="width: 30%">Li·ªÅu d√πng</th>
            <th style="width: 30%">C√°ch d√πng</th>
          </tr>
        </thead>
        <tbody id="don_thuoc_body">
          <!-- D·ªØ li·ªáu thu·ªëc s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </tbody>
      </table>
    </div>

    <div class="exam-footer">
      <p style="text-align: right">Ng√†y in: <span id="ngay_in"></span></p>
      <div class="signature-block">
        <p class="signature-line">B√°c sƒ© k√Ω t√™n</p>
        <p class="signature-line">B·ªánh nh√¢n k√Ω t√™n</p>
      </div>
    </div>
  </div>
</div>

<div class="text-center mt-4 no-print">
  <button class="btn btn-success" onclick="window.print()">
    üñ®Ô∏è In Phi·∫øu Kh√°m
  </button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const maPhieuKham = {{ ma_phieu_kham }};
    try {
      const response = await fetch(`http://localhost:5000/medical_exams/${maPhieuKham}`);
      const data = await response.json();

      if (!response.ok) {
        alert("‚ùå Kh√¥ng t√¨m th·∫•y phi·∫øu kh√°m!");
        return;
      }

      // Hi·ªÉn th·ªã d·ªØ li·ªáu phi·∫øu kh√°m
      document.getElementById("ma_phieu_kham").textContent = data.ma_phieu_kham;
      document.getElementById("ten_benh_nhan").textContent = data.ten_benh_nhan;
      document.getElementById("ngay_kham").textContent = new Date(data.ngay_kham).toLocaleString("vi-VN");
      document.getElementById("trieu_chung").textContent = data.trieu_chung;
      document.getElementById("chan_doan").textContent = data.chan_doan;

      // Hi·ªÉn th·ªã ng√†y in
      document.getElementById("ngay_in").textContent = new Date().toLocaleDateString("vi-VN");

      // L·∫•y ƒë∆°n thu·ªëc t·ª´ API
      const resThuoc = await fetch(`http://localhost:5000/prescriptions/${maPhieuKham}`);
      const thuocData = await resThuoc.json();

      if (resThuoc.ok && Array.isArray(thuocData)) {
        const tbody = document.getElementById("don_thuoc_body");
        thuocData.forEach((item) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.ten_thuoc}</td>
            <td>${item.lieu_dung || ""}</td>
            <td>${item.cach_dung || ""}</td>
          `;
          tbody.appendChild(row);
        });
      } else {
        console.warn("Kh√¥ng c√≥ ƒë∆°n thu·ªëc ho·∫∑c l·ªói d·ªØ li·ªáu");
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß!");
    }
  });
</script>
{% endblock %}
